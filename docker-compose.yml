version: "3.6"

services:
  webcsd:
    environment:
      - CsdRepository__ServiceLocation=webcsdbackend
      - CspRepository__ServiceLocation=webcsd-theory
    depends_on:
      - ccdc-csd-searchservice
      - csd-request-entry
    image: ccdcrepository.azurecr.io/webcsd:latest
    ports:
      - 80:80
    volumes:
      - ./userdata:/app/OnSite
      - ./structure-files:/structure-files
    labels:
      kompose.image-pull-secret: regcred
      kompose.service.type: LoadBalancer
      kompose.service.expose: "true"
      # kompose.volume.size: 1Gi

  webcsdbackend:
    depends_on:
      - ccdc-csd-searchservice
      - csd-request-entry
    image: ccdcrepository.azurecr.io/webcsdbackend:latest
    environment:
      - ServiceSettings__StructureInfoLocation=/csd-data/structure-links.csv
      - CCDC_LICENSING_CONFIGURATION=la-code;5ABDA4-F20240-48D6A3-1273C3-0A321F-71F963;service=ccdc-test-on-premise
      - ServiceSettings__Databases__1__Name=RP1
      - ServiceSettings__Databases__1__Colour=#FF0000
      - ServiceSettings__Databases__1__ConnectionString=/csd-data/Main_RP_DB.csdsql
      - ServiceSettings__Databases__2__Name=solubility
      - ServiceSettings__Databases__2__Colour=RGBA(255,0,0,.5)
      - ServiceSettings__Databases__2__ConnectionString=/csd-data/solubility.csdsql
      - ServiceSettings__Databases__2__Speciality__0=Solubility
      - ServiceSettings__Databases__3__Name=CSP Database
      - ServiceSettings__Databases__3__Colour=aqua
      - ServiceSettings__Databases__3__ConnectionString=/csd-data/CSPLandscape.csdsqlx
    volumes:
      - ./csd-data:/csd-data
    labels:
      kompose.image-pull-secret: regcred
    expose:
      - 80

  redis:
    image: redis
    restart: always
    command: redis-server --requirepass 'Password123'

  database-server:
    image: ccdcrepository.azurecr.io/csd-database:2022.1.0.alpha2
    restart: always
    environment:
      - POSTGRES_PASSWORD=${CSD_DB_PASSWORD}
    command:
      - "postgres"
      - "-c"
      - "max_connections=1000"

  ccdc-csd-substructuresearch:
    image: ccdcrepository.azurecr.io/ccdc-csd-substructuresearch:0.1.6
    depends_on:
      - database-server
      - ccdc-csd-resultstore
      - ccdc-csd-substructure-filter
      - ccdc-csd-fingerprint
      - ccdc-csd-deposition
    environment:
      - StructureSearchReadConnection=Server=database-server;Port=5432;Database=csd-database;User Id=postgres;Password=${CSD_DB_PASSWORD};SearchPath=substructure

  ccdc-csd-deposition:
    image: ccdcrepository.azurecr.io/ccdc-csd-deposition:0.1.6
    depends_on:
      - database-server
    environment:
      - CsdReadConnection=Server=database-server;Port=5432;Database=csd-database;User Id=postgres;Password=${CSD_DB_PASSWORD};SearchPath=csd_schema

  ccdc-csd-textnumericsearch:
    depends_on:
      - database-server
    image: ccdcrepository.azurecr.io/ccdc-csd-textnumericsearch:0.1.6
    environment:
      - CsdReadConnection=Server=database-server;Port=5432;Database=csd-database;User Id=postgres;Password=${CSD_DB_PASSWORD};SearchPath=csd_schema

  ccdc-csd-searchservice:
    depends_on:
      - ccdc-csd-textnumericsearch
      - ccdc-csd-substructuresearch
      - ccdc-csd-resultstore
    image: ccdcrepository.azurecr.io/ccdc-csd-searchservice:0.1.6

  csd-request-entry:
    depends_on:
      - ccdc-csd-deposition
      - ccdc-csd-crystal-structure-export
      - database-server
    image: ccdcrepository.azurecr.io/csd-request-entry:0.1.6
    environment:
      - CsdReadConnection=Server=database-server;Port=5432;Database=csd-database;User Id=postgres;Password=${CSD_DB_PASSWORD};SearchPath=csd_schema

  ccdc-csd-formulasearch:
    depends_on:
      - database-server
    image: ccdcrepository.azurecr.io/ccdc-csd-formulasearch:0.1.6
    environment:
      - FormulaSearchReadConnection=Server=database-server;Port=5432;Database=csd-database;User Id=postgres;Password=${CSD_DB_PASSWORD};SearchPath=formula

  ccdc-csd-unitcellsearch:
    depends_on:
      - database-server
      - ccdc-csd-reducedcell-calculation-service
    image: ccdcrepository.azurecr.io/ccdc-csd-unitcellsearch:0.1.6
    environment:
      - UnitCellSearchReadConnection=Server=database-server;Port=5432;Database=csd-database;User Id=postgres;Password=${CSD_DB_PASSWORD};SearchPath=unitcell

  ccdc-csd-resultstore:
    image: ccdcrepository.azurecr.io/ccdc-csd-resultstore:0.1.6
    environment:
      - OrderedCachePassword=${CSD_CACHE_PASSWORD}

  ccdc-csd-fingerprint:
    image: ccdcrepository.azurecr.io/ccdc-csd-fingerprint-service:0.1.6

  ccdc-csd-substructure-filter:
    image: ccdcrepository.azurecr.io/ccdc-csd-substructure-filter-service:0.1.6

  ccdc-csd-crystal-structure-export:
    image: ccdcrepository.azurecr.io/ccdc-csd-crystal-structure-export-service:0.1.6

  ccdc-csd-reducedcell-calculation-service:
    image: ccdcrepository.azurecr.io/ccdc-csd-reducedcell-calculation-service:0.1.6

  webcsd-theory:
    image: ccdcrepository.azurecr.io/csd-theory:latest
    environment:
      - CCDC_LICENSING_CONFIGURATION=${CCDC_LICENSING_CONFIGURATION};

volumes:
  csd_data: {}
